<main class="find-buddies-container">
  <h1>Find Workout Buddies</h1>
    {{#if error}}
      <div class="error-msg">{{error}}</div>
    {{/if}}

    {{#if success}}
      <div class="success-msg">{{success}}</div>
    {{/if}}


  <!-- Filters Section -->
  <form id="filterForm" method="GET" action="/gymBuddy/find" class="filter-form">
    <div class="filter-group">
      <label for="experienceFilter">Experience:</label>
      <select name="experience" id="experienceFilter">
        <option value="">All Experience Levels</option>
        <option value="newcomer" {{#if (eq currentExperience "newcomer")}}selected{{/if}}>Newcomer</option>
        <option value="1+ year" {{#if (eq currentExperience "1+ year")}}selected{{/if}}>1+ Year</option>
        <option value="3+ year" {{#if (eq currentExperience "3+ year")}}selected{{/if}}>3+ Years</option>
        <option value="5+ year" {{#if (eq currentExperience "5+ year")}}selected{{/if}}>5+ Years</option>
        <option value="10+ year" {{#if (eq currentExperience "10+ year")}}selected{{/if}}>10+ Years</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="workoutTypeFilter">Workout Type:</label>
      <select name="workoutType" id="workoutTypeFilter">
        <option value="">All Workout Types</option>
        <option value="Cardio" {{#if (eq currentWorkoutType "Cardio")}}selected{{/if}}>Cardio</option>
        <option value="Body Building" {{#if (eq currentWorkoutType "Body Building")}}selected{{/if}}>Body Building</option>
        <option value="Power Lifting" {{#if (eq currentWorkoutType "Power Lifting")}}selected{{/if}}>Power Lifting</option>
        <option value="Calisthenics" {{#if (eq currentWorkoutType "Calisthenics")}}selected{{/if}}>Calisthenics</option>
        <option value="Yoga" {{#if (eq currentWorkoutType "Yoga")}}selected{{/if}}>Yoga</option>
        <option value="Other" {{#if (eq currentWorkoutType "Other")}}selected{{/if}}>Other</option>
      </select>
    </div>

    <button type="submit">Filter</button>
  </form>

  <!-- Loop through all sessions -->
  <div class="session-grid-wrapper">
    {{#each sessions}}
      <div class="session-grid">
        <h3>{{this.title}}</h3>
        <p><strong>Gym:</strong> {{this.gym}}</p>
        <p><strong>Date:</strong> {{this.formattedDateTime}}</p>
        <p><strong>Hosted By:</strong> {{this.hostedBy.username}}</p>
        <p><strong>Slots:</strong> {{this.currentMembers}} / {{this.maxMembers}}</p>

        <button type="button" onclick="openModal('{{this._id}}')">View Details</button>

        <!-- Modal -->
        <div id="modal-{{this._id}}" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeModal('{{this._id}}')">&times;</span>
            <h2>{{this.title}}</h2>
            <p><strong>Hosted By:</strong> {{this.hostedBy.username}}</p>
            <p><strong>Gym:</strong> {{this.gym}}</p>
            <p><strong>Description:</strong> {{this.description}}</p>
            <p><strong>Location:</strong> {{this.gymlocation}}</p>
            <p><strong>Experience:</strong> {{this.experience}}</p>
            <p><strong>Workout Type:</strong> {{this.workoutType}}</p>
            <p><strong>Date & Time:</strong> {{this.formattedDateTime}}</p>
            <p><strong>Slots:</strong> {{this.currentMembers}} / {{this.maxMembers}}</p>
            {{#if this.members}}
                {{#if this.members.length}}
                    <p><strong>Attending:</strong></p>
                <ul>
                {{#each this.members}}
                <li>{{this.username}}</li>
                {{/each}}
            </ul>
            {{else}}
            <p><em>No members joined yet.</em></p>
            {{/if}}
            {{/if}}
            
        
            {{#if this.isHost}}
              <p class="host-msg">You are hosting this session üßë‚Äçüè´</p>
            {{else}}
              {{#if this.hasJoined}}
                  <p class="joined-msg">You‚Äôve already joined this session ‚úÖ</p>
                  <form action="/gymBuddy/leave/{{this._id}}" method="POST" onsubmit="return confirm('Are you sure you want to leave this session?');">
                    <button type="submit">Leave Session</button>
                  </form>
                {{else}}
                  {{#if ../isLoggedIn}}
                    <form action="/gymBuddy/join/{{this._id}}" method="POST">
                      <button type="submit" {{#if (eq this.currentMembers this.maxMembers)}}disabled{{/if}}>
                        {{#if (eq this.currentMembers this.maxMembers)}}Full{{else}}Join{{/if}}
                      </button>
                    </form>
                  {{else}}
                    <a href="/login?error=Please log in to join a session">
                      <button>Login to Join</button>
                    </a>
                  {{/if}}
                {{/if}}
            {{/if}}
          </div>
        </div>
      </div>
    {{/each}}
  </div>

  <!-- Modal JS -->
  <script>
    function openModal(id) {
      document.getElementById(`modal-${id}`).style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(`modal-${id}`).style.display = "none";
    }

    window.onclick = function (event) {
      document.querySelectorAll('.modal').forEach(modal => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      });
    }
  </script>
</main>
